using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Interfaces;
using System.Reflection;
using System.Security.Cryptography.X509Certificates;
using System.ServiceModel;
using System.ServiceModel.Security;
using Common;
using System.Security.Principal;

namespace ClientTests
{
    class Program
    {
        static void Main(string[] args)
        {

            string srvCertCN = "wcfservicefalse";

            X509Certificate2 srvCert = Certificate.GetCertificateFromStorage(StoreName.My, StoreLocation.LocalMachine, srvCertCN);



            NetTcpBinding binding = new NetTcpBinding();
            //binding.Security.Transport.ClientCredentialType = TcpClientCredentialType.Certificate;


            EndpointAddress address = new EndpointAddress(new Uri("net.tcp://10.1.212.110:40001/AntiMalwareStandby"), new X509CertificateEndpointIdentity(srvCert));
            EndpointAddress address2 = new EndpointAddress(new Uri("net.tcp://localhost:40001/AntiMalwareStandby"), new X509CertificateEndpointIdentity(srvCert));


            IClient cl = new ClientFalseCert(binding, address);






            Console.WriteLine(((ClientFalseCert)cl).IsEventClient);
            try
            {
                using (ClientFalseCert proxy = new ClientFalseCert(binding, address))
                {
                    /// 1. Communication test to establish authentication
                    //      proxy.update();
                    try
                    {
                        int isEventClient = 1;
                        try
                        {
                            isEventClient = Int32.Parse(args[0]);
                        }
                        catch (Exception ex)
                        {
                            Logger.LogWarning("Parametar nije postavljen.");
                            Console.WriteLine(ex.Message);
                        }
                        proxy.EndPointAddreses.Add(address, true);
                        proxy.EndPointAddreses.Add(address2, false);
                        proxy.IsEventClient = isEventClient;
                        proxy.Binding = binding;

                        X509Certificate2 cert = proxy.getCertificate();
                        if (cert == null)
                        {
                            Console.WriteLine("Server nije poslao svoj sertifikat!");
                            return;
                        }
                        Byte[] data = new Byte[24];
                        Byte[] resp = proxy.exchangeData(data);
                        if (resp != null)
                        {
                            String str = RSACrypting.GetString(resp);
                            var cleaned = str.Replace("\0", string.Empty);
                            if (cleaned.Equals("OK"))
                            {
                                Logger.LogInformation("Handshake uspesan");
                                Console.WriteLine("Handshake uspesan!");
                            }
                            else
                            {
                                Logger.LogError("Handshake nije bio uspesan! Pokusajte ponovo da pokrenete aplikaciju i da imate odogovarajuce privilegije!");
                                Console.WriteLine("Handshake nije bio uspesan! \nPokusajte ponovo da pokrenete aplikaciju i da imate odogovarajuce privilegije!");
                                return;
                            }
                        }
                        proxy.getSignature();
                        // Console.WriteLine("TestCommunication() finished. Press <enter> to continue ...");
                        // Console.ReadLine();
                    }
                    catch (FaultException)
                    {
                        Logger.LogError("Desio se fault exception");
                        Console.WriteLine("FAULTE EXCEPTION");
                        proxy.Abort();
                    }
                    catch (CommunicationException ex)
                    {
                        Logger.LogError("Desio se communication exception");
                        Console.WriteLine("COMMUNICATION EXCEPTION");
                        Console.WriteLine(ex.Message);
                        Console.WriteLine(ex.StackTrace);
                        proxy.Abort();
                    }
                    catch (TimeoutException)
                    {
                        Logger.LogError("Desio se timeout exception");
                        Console.WriteLine("TIMEOUT EXCEPTION");
                        proxy.Abort();
                    }
                }
            }
            catch (Exception)
            {
                Logger.LogInformation("Kraj");
                Console.WriteLine("Gotovo je!");
                return;
            }


        }
        
        
    }
}
